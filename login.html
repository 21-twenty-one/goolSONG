<!DOCTYPE html>
<html>
<head>
<title>TREZOR Login</title>
<script src="https://trezor.github.io/connect/trezor.js" type="text/javascript"></script>
</head>
<style type="text/css">
body {
	margin: 0;
	padding: 0;
}
#main {
	background: #eee;
	color: #333;
	font-family: Helvetica, Arial, sans-serif;
	width: 400px;
	height: 300px;
}
#top {
	background: #333 8px 4px no-repeat url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAAAwCAYAAADZ9HK+AAAFiUlEQVR42u2ca4hVVRTHf8vU1Cl1fDuphaZMWVkGPbQsMagpoegBWUZfkgQjg6QQQ/JDRWjQA3uKEJb2ISGI0lTIV0K+sixQfBAGVmTqqONMjfrvg3vietr73nPu3Ma5d/YfDueevdfaj7XW2Wudtc+5EBEREREREdERYa1hlnQHMAw4Cewws11RpBUOSdMk7ZAfpyQtlTQsSqryFF8jabfSY3aUWuUof4CkM8qOL6P0KsMAjgcU3CRpo6RdeYxgSZRgeSt/q0epqyT1S9B1kTQ2YAR9oyTLU/n9PMpcWICnt6SjCZ69UZrlaQBzE4r8KSXfbR7D6RMlWn4GcDihxKkZeHcmeEdHibY/dMqjQAOqE8WrMrS9LnF9cxR3GRkA0M1T9keGtg8nrmMgWGYGENEB0DkLsZnpf445BgFrgCz9dDGzWknbgK556M64VekbYJ6ZNef0uzbDCmXAeOBd4KoMN9rLZvZxYr6jgNnAOGB4jj4OAFuAt8xsnUdOXwP9CvR5DPgBmG9m+zMbgJk1Skp2PAPo7WKD7k7gXZxw/waagXrgKDA2Oe40ygSKDRZHAxemoLsdmCNpvJltcmW1wMAMfV0AjMhgACQVJukdYHqAdpg7HpC0GrjXzBpz6muBQSn6HAdMl/SUmS1MexeOkLTERe7FpH/zYZ+kJyR1D/Q9tJhGHW9TEazdHO9vGfn6SNqckWem66uTpF+KGGvPHDn9WgT/9WljgN3A1JzlrpQYDnwArGgnLvCztnyqduePgCF53FRopdzayv43pTUAawNhhILPg0ANMNgd1R6azc4NtdDUBNr62fn1FppZHporA7wnnUsY7DlqnIur89T1cq7Qh7clXQFM8dRtA/q7+VYDH3poRkp6LND2CeDinHHc7aHpKqkmjQs4rf8f6zMEhklsCNA1FUo/e+Z2KOACGiT1klTtOfq4HIlvDN8G5nu1q3/VU7c80Nazobl7XMAxD/8yD39tMU8BG4DvXWR6yAV5DcAp4LQ7d3YBXBegCujpLPpS4FrgpvOwvHeTdKMbU0tAlFx5mgK8PdxdHsJFTga5An8JuMFD+6SZ7XS/H/bUTwsE4a9JWpAoviUUlEq6zskeYCgw2UPXkHUF+KpEj3erz8MKkAariwwCqxJ9j0mz0nnqjxSY+9pAwFtMENgcE0H/xUMlMO5qYIen6nczm5AyMMyXcygVJkYDOBd3mtnRErSzPVA+0lN2IHFdXeBdiQklmus8M9sYDeBc5efb2Grg7F5Ile8wswZ3978OXObhf9zMjnvKP/GUvR9YWZ7xFG8sYq7LzOzFkqSCywx7zGyUpEkuvZyLBcA1BVLkk0M3iKTPgQeBmYEV4bCkpHvZDywGnkuU3+9Su7OB71yu5AXgEU/b74XSvmbWy42tOaHX+7L6tEoJAvfm1PmCvLoC9YUygdsz8ix2fS0t8tH5xzyZwGO5+wQe3vlZEzKVhhmeslda2eapjPQtUfijwJ6MvPXArSlpfY9/syT16MgG8IWnbIykyW09EDOTmY0CVpJug2wfUG1mR1K23wDs9FQ9XykGoJTlyhFKEzDHw/OGO58p0RiyGEIdZ1PHiwIkK4AaM7vcsw1f6NqX9p4raUDZxQAdBS713N+lm62t+u0cRd8+YGb156PftnIBiipunyhkAAMlDWnl0jYEuCSKunx80enAZ9/T0/omSSZpqqTG1m4HR7QPA/h3R0nSgdAHIpImSdor6a9SvQ8Q0fYGkBYnJa2XNEXSckl/ZuDdEiXdfg2gr6SnA18FtwYNkhZJmhilXF7Ppm+6t3mLwQlJayTdE6VZ/sbQX9KnkuoLKL3R/WFEXZRaZRqCSRokaWVC8Qcl3SUpfm7WgYyhSlJt/AeQiIiIiIiIiIjywj96I9wHYT5hWgAAAABJRU5ErkJggg==');
	color: #fff;
	height: 56px;
	line-height: 56px;
	padding-right: 12px;
	text-align: right;
	font-size: 30px;
}
#middle {
	font-size: 21px;
	text-align: center;
	height: 156px;
	padding-top: 40px;
}
#bottom {
	background: #333;
	color: #fff;
	height: 48px;
	line-height: 48px;
	font-size: 16px;
	text-align: center;
}
</style>
<body>

<div id="main">
  <div id="top">Sign in</div>
  <div id="middle">
    <img id="login_icon" width="96" height="96"
         src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAQAAABIkb+zAAAEOUlEQVR42u2cb2iVVRjAf9dtjrvNFE1XY5lTIxd9mY8ysAhxjLIPRYVW9AdkhYwQTUEm+UEjiGDloij6UrSozKJIIT/YLv2bIO4h8IMrSDdGciXLGlc3Nrfdvul9313vfV92z3nvgfe5X+4597z3Pr97znme8zznPW+CgCKVLKOdJ2ihnipsSJZRfud7PmNYx27WKBFQ/RXs5RluIRpJ0aPH5gAgLRynnihlgk/0xXwfVARQv5XT1BGtVLK2YUnDifRMaABpJkWScpBWLqQ15BCSaj7mScpHGvWCv2sKy8q86s9YUnferJr3eSQcwA5feZpezjBpxYgmaGQLqz21D8gKHQ4D8LynNE47p3TK3oiRN/mJe3IqkmxguHAn5V6+mFpPRY/221Qf9B/fkJnPqmKjLFeafP//L/ZnrZ5jyFNxqySCA1T7xv+VSCzPRU+pihAADkgMEAPEADFADBADxAAOA0id3OEwgHSSYUT6ZaGTAHIn7wGwgT5Z7WIPtN1gYUBa3QNYnvN+If3yaPkBeLNGSV/r+b62R2S3fYDCQf0QB7gRA09y3pc3wAfULS36XBkB6J8cDPVtCZ6VCjp11GVH9jRfS5PbnngTP0iL20uJ5aRsmVVTa6FF/Czb3V7MVfGuvGbVCkmCRT7bXkjGfWnHfN/9itTQpZNWAGQBXTxGfdBdM7KBtj1eZo10aNo4gFTyOi8Z+YXN9MlG/cv0HFjKNmN/UjPnpdk0wGJqDA7UWgZkq1mAasPGoobDssskQNa4vUtwSHpknikAO7KTw1LrMgBsYUDqXAaANaW1SVHkhZbSJw+7DAC38410uQxgLSY2JWle0O/cBbhEmw662wO/sV5LuN9sew58yTot6Xa5XYC3eUqvmpnECePKZ9mtPeas0IRh9cfYpkdMmtHLjBmMCK6yvnR2J/8cuMRHxtQfZKUp9a/3gE7JPkZDB/VBwvrjdJiLiHP8gGZkP92h0iqvsrNoq0PW0iqgWf4Nc6kUM4hTvKH73V0LXWOHfuDuYu4/HtJTNnyjGU88wiY76psBSLFRf7W1Oik9wOc8rkNlEtBIIx2eTb4vdKSIb/i0rDb5aOJATmma0+QC+F3eJPv0rfIKKad9rmvGV/a23arfuhUT5+4aj/KgLbtTukl89HpGVVkXjfpzAtAM7VwBTtKmfziZVtE+FkhSx4lQ5uwHolU/vmcuBogBYoAYIAaIAWIAgwDenHVFROe6b/OUrnlviygM4A3Ok9xvX3tZ5TvR+bcGB9DLeNOHu+Q+sbqrJks46ou7z4WLB3rp9PTBj/RKlAeixznpbVbsTH0zZ/NUR3ck/Zj6jqQXeapBQ4a7uHdWdcLSa7a0pTOhzKhOcDBc0t2obPc/0yCAH9BBNpeJ+u/wIXkGQxBb4PajSSB9seErqrnb+K2BN5MUe7Q7/0eBN7jL9fE8/wPTvRS9jzBrBwAAAABJRU5ErkJggg==">
    <br>
    <strong id="login_label"></strong>
  </div>
  <div id="bottom">
    Please connect your TREZOR device ...
  </div>
</div>

<script type="text/javascript">

function receiveMessage(event)
{
	var request = event.data;
	if (!request || !request.identity) return;
	var label = '';
	if (request.identity.proto) label += request.identity.proto + '://';
	if (request.identity.user) label += request.identity.user + '@';
	if (request.identity.host) label += request.identity.host;
	if (request.identity.port) label += ':' + request.identity.port;
	if (request.identity.path) label += request.identity.path;
	document.getElementById('login_label').innerHTML = label;
	if (request.icon) document.getElementById('login_icon').src = request.icon;

	// FIXME: how to do this properly and pass request object to line 131?
	window.request = request;

	trezor
		.loadTransport()
		.then(configureTransport)
		.then(getSession)
		.then(callSignIdentity)
		// success
		.then(function(response) {
			console.log(response);
			response.success = true;
			event.source.postMessage(response, event.origin);
			window.close();
		})
		// failure
		.catch(function(error) {
			console.error(error);
			var response = {};
			response.success = false;
			response.error = error;
			event.source.postMessage(response, event.origin);
			window.close();
		});
}

window.addEventListener('message', receiveMessage, false);

function configureTransport(transport) {
	return trezor
		.http('https://mytrezor.com/data/plugin/config_signed.bin')
		.then(function (config) {
			return transport.configure(config);
		})
		.then(function () {
			return transport;
		});
}

function getSession(transport) {
	return transport.enumerate()
		.then(function (devices) {
			if (!devices.length) {
				throw new Error('No connected devices.');
			}
			return transport.acquire(devices[0]);
		})
		.then(function (result) {
			var id = result.session;
			return new trezor.Session(transport, id);
		})
		.then(function (session) {
			session.initialize();
			return session;
		});
}

function callSignIdentity(session) {
	var request = window.request; // FIXME
	return session.signIdentity(request.identity, request.challenge_hidden, request.challenge_visual).then(function (result) {
		var response = {};
		response.challenge_hidden = request.challenge_hidden;
		response.challenge_visual = request.challenge_visual;
		response.address = result.message.address;
		response.public_key = result.message.public_key;
		response.signature = result.message.signature;
		return response;
	});
}

</script>

</body>
</html>
