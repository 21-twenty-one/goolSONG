<!DOCTYPE html>
<html>
<head>
<title>TREZOR Login</title>
<script src="https://trezor.github.io/connect/trezor.js" type="text/javascript"></script>
</head>
<style type="text/css">
body {
	margin: 0;
	padding: 0;
}
#main {
	background: #eee;
	color: #333;
	font-family: Helvetica, Arial, sans-serif;
	width: 400px;
	height: 300px;
}
#top {
	background: #333 8px 4px no-repeat url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAAAwCAYAAADZ9HK+AAAFiUlEQVR42u2ca4hVVRTHf8vU1Cl1fDuphaZMWVkGPbQsMagpoegBWUZfkgQjg6QQQ/JDRWjQA3uKEJb2ISGI0lTIV0K+sixQfBAGVmTqqONMjfrvg3vietr73nPu3Ma5d/YfDueevdfaj7XW2Wudtc+5EBEREREREdERYa1hlnQHMAw4Cewws11RpBUOSdMk7ZAfpyQtlTQsSqryFF8jabfSY3aUWuUof4CkM8qOL6P0KsMAjgcU3CRpo6RdeYxgSZRgeSt/q0epqyT1S9B1kTQ2YAR9oyTLU/n9PMpcWICnt6SjCZ69UZrlaQBzE4r8KSXfbR7D6RMlWn4GcDihxKkZeHcmeEdHibY/dMqjQAOqE8WrMrS9LnF9cxR3GRkA0M1T9keGtg8nrmMgWGYGENEB0DkLsZnpf445BgFrgCz9dDGzWknbgK556M64VekbYJ6ZNef0uzbDCmXAeOBd4KoMN9rLZvZxYr6jgNnAOGB4jj4OAFuAt8xsnUdOXwP9CvR5DPgBmG9m+zMbgJk1Skp2PAPo7WKD7k7gXZxw/waagXrgKDA2Oe40ygSKDRZHAxemoLsdmCNpvJltcmW1wMAMfV0AjMhgACQVJukdYHqAdpg7HpC0GrjXzBpz6muBQSn6HAdMl/SUmS1MexeOkLTERe7FpH/zYZ+kJyR1D/Q9tJhGHW9TEazdHO9vGfn6SNqckWem66uTpF+KGGvPHDn9WgT/9WljgN3A1JzlrpQYDnwArGgnLvCztnyqduePgCF53FRopdzayv43pTUAawNhhILPg0ANMNgd1R6azc4NtdDUBNr62fn1FppZHporA7wnnUsY7DlqnIur89T1cq7Qh7clXQFM8dRtA/q7+VYDH3poRkp6LND2CeDinHHc7aHpKqkmjQs4rf8f6zMEhklsCNA1FUo/e+Z2KOACGiT1klTtOfq4HIlvDN8G5nu1q3/VU7c80Nazobl7XMAxD/8yD39tMU8BG4DvXWR6yAV5DcAp4LQ7d3YBXBegCujpLPpS4FrgpvOwvHeTdKMbU0tAlFx5mgK8PdxdHsJFTga5An8JuMFD+6SZ7XS/H/bUTwsE4a9JWpAoviUUlEq6zskeYCgw2UPXkHUF+KpEj3erz8MKkAariwwCqxJ9j0mz0nnqjxSY+9pAwFtMENgcE0H/xUMlMO5qYIen6nczm5AyMMyXcygVJkYDOBd3mtnRErSzPVA+0lN2IHFdXeBdiQklmus8M9sYDeBc5efb2Grg7F5Ile8wswZ3978OXObhf9zMjnvKP/GUvR9YWZ7xFG8sYq7LzOzFkqSCywx7zGyUpEkuvZyLBcA1BVLkk0M3iKTPgQeBmYEV4bCkpHvZDywGnkuU3+9Su7OB71yu5AXgEU/b74XSvmbWy42tOaHX+7L6tEoJAvfm1PmCvLoC9YUygdsz8ix2fS0t8tH5xzyZwGO5+wQe3vlZEzKVhhmeslda2eapjPQtUfijwJ6MvPXArSlpfY9/syT16MgG8IWnbIykyW09EDOTmY0CVpJug2wfUG1mR1K23wDs9FQ9XykGoJTlyhFKEzDHw/OGO58p0RiyGEIdZ1PHiwIkK4AaM7vcsw1f6NqX9p4raUDZxQAdBS713N+lm62t+u0cRd8+YGb156PftnIBiipunyhkAAMlDWnl0jYEuCSKunx80enAZ9/T0/omSSZpqqTG1m4HR7QPA/h3R0nSgdAHIpImSdor6a9SvQ8Q0fYGkBYnJa2XNEXSckl/ZuDdEiXdfg2gr6SnA18FtwYNkhZJmhilXF7Ppm+6t3mLwQlJayTdE6VZ/sbQX9KnkuoLKL3R/WFEXZRaZRqCSRokaWVC8Qcl3SUpfm7WgYyhSlJt/AeQiIiIiIiIiIjywj96I9wHYT5hWgAAAABJRU5ErkJggg==');
	color: #fff;
	height: 56px;
	line-height: 56px;
	padding-right: 12px;
	text-align: right;
	font-size: 30px;
}
#middle {
	font-size: 21px;
	text-align: center;
	height: 156px;
	padding-top: 40px;
}
#bottom {
	background: #333;
	color: #fff;
	height: 48px;
	line-height: 48px;
	font-size: 16px;
	text-align: center;
}
</style>
<body>

<div id="main">
  <div id="top">Sign in</div>
  <div id="middle">
    <img id="login_icon" width="96" height="96" src="">
    <br>
    <strong id="login_origin"></strong>
  </div>
  <div id="bottom">
    <span id="status_bar">Please connect your TREZOR device ...</span>
  </div>
</div>

<script type="text/javascript">

function buttonCallback(code)
{
	document.getElementById('status_bar').innerHTML = '<strong>Confirm action on your device ...</strong>';
}

function pinCallback(type, callback)
{
	var pin = prompt('Enter PIN:');
	callback(null, pin);
}

function passphraseCallback(callback)
{
	var passphrase = prompt('Enter Passphrase:');
	callback(null, passphrase);
}

function receiveMessage(event)
{
	var request = event.data;
	if (!request || !request.trezor_login) return;
	var loc = event.origin.split(':');
	request.identity = {};
	request.identity.proto = loc[0];
	request.identity.user = null;
	request.identity.host = loc[1].substring(2);
	request.identity.port = loc[2] ? loc[2] : null;
	request.identity.path = null;
	request.identity.index = 0;
	document.getElementById('login_origin').innerHTML = event.origin;
	if (request.icon) document.getElementById('login_icon').src = request.icon;

	// FIXME: how to do this properly and pass request object to function callSignIdentity?
	window.request = request;

	trezorLogin(event);
}

window.addEventListener('message', receiveMessage, false);

function trezorLogin(event) {
	trezor
		.loadTransport()
		.then(configureTransport)
		.then(getSession)
		.then(callSignIdentity)
		// success
		.then(function(response) {
			console.log(response);
			response.success = true;
			event.source.postMessage(response, event.origin);
			window.close();
		})
		// failure
		.catch(function(error) {
			console.error(error);
			if (error.message == 'No connected devices.') {
				setTimeout(function(){ trezorLogin(event); }, 3000);
			} else {
				var response = {};
				response.success = false;
				response.error = error.message;
				event.source.postMessage(response, event.origin);
				window.close();
			}
		})
		.done();
}

function configureTransport(transport) {
	return trezor
		.http('https://trezor.github.io/connect/config_signed.bin') // FIXME: download from mytrezor.com after fixing CORS
		.then(function (config) {
			return transport.configure(config);
		})
		.then(function () {
			return transport;
		});
}

function getSession(transport) {
	return transport.enumerate()
		.then(function (devices) {
			if (!devices.length) {
				throw new Error('No connected devices.');
			}
			return transport.acquire(devices[0]);
		})
		.then(function (result) {
			var id = result.session;
			return new trezor.Session(transport, id);
		})
		.then(function (session) {
			return session.initialize()
				.then(function (result) {
					session.on('button', buttonCallback);
					session.on('pin', pinCallback);
					session.on('passphrase', passphraseCallback);
					return session;
				});
		});
}

function callSignIdentity(session) {
	var request = window.request; // FIXME
	return session.signIdentity(request.identity, request.challenge_hidden, request.challenge_visual).then(function (result) {
		var response = {};
		response.challenge_hidden = request.challenge_hidden;
		response.challenge_visual = request.challenge_visual;
		response.address = result.message.address;
		response.public_key = result.message.public_key;
		response.signature = result.message.signature;
		return response;
	});
}

</script>

</body>
</html>
